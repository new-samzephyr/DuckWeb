<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No Time to Think</title>
    <style>
        /* Your existing CSS */
    </style>
</head>
<body>
    <!-- Your existing HTML content -->
    <script>
        let topics = [];
        let timer;
        let timeLeft = 20; // Default to 20 seconds
        let currentTopicIndex = 0;
        let isPaused = false;
        let usedTopics = [];
        let skippedTopics = [];
        let completedTopics = {
            'A': 0,
            'B': 0,
            'C': 0
        };
        let playerLevel = 'B'; // Default to B level

        // Fetch and flatten topics from JSON file
        fetch('NTTT-Topics.json')
            .then(response => response.json())
            .then(data => {
                // Flatten the nested JSON structure into a single array
                topics = Object.values(data).flat();
                console.log('Topics loaded:', topics);
            })
            .catch(error => console.error('Error fetching topics:', error));

        function updateTimer() {
            if (isPaused) return;
            if (timeLeft <= 0) {
                changeTopic();
                timeLeft = parseInt(document.getElementById('time-selector').value);
            } else {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
            }
        }

        function startPauseGame() {
            const startPauseButton = document.getElementById('start-pause');
            const definitionLink = document.getElementById('definition-link');
            const timeSelector = document.getElementById('time-selector');

            if (!timer) {
                changeTopic();
                timer = setInterval(updateTimer, 1000);
                startPauseButton.innerText = 'Pause';
                document.getElementById('restart').style.display = 'block';
                document.getElementById('skip').style.display = 'block';
                definitionLink.style.display = 'block';
                timeSelector.disabled = true;
            } else if (isPaused) {
                isPaused = false;
                startPauseButton.innerText = 'Pause';
            } else {
                isPaused = true;
                startPauseButton.innerText = 'Continue';
            }
        }

        function restartGame() {
            clearInterval(timer);
            timer = null;
            timeLeft = parseInt(document.getElementById('time-selector').value);
            currentTopicIndex = 0;
            isPaused = false;
            usedTopics = [];
            skippedTopics = [];
            completedTopics = {
                'A': 0,
                'B': 0,
                'C': 0
            };
            document.getElementById('topic').innerText = 'Press Start to Begin';
            document.getElementById('timer').innerText = timeLeft;
            document.getElementById('restart').style.display = 'none';
            document.getElementById('skip').style.display = 'none';
            document.getElementById('start-pause').innerText = 'Start';
            document.getElementById('definition-link').style.display = 'none';
            document.getElementById('time-selector').disabled = false;
        }

        function changeTopic() {
            if (usedTopics.length === topics.length) {
                usedTopics = [];
            }

            let filteredTopics = filterTopicsByLevel();

            if (filteredTopics.length === 0) {
                filteredTopics = topics;
            }

            if (filteredTopics.length === 0) {
                console.error('No topics available after filtering.');
                return;
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * filteredTopics.length);
            } while (usedTopics.includes(filteredTopics[randomIndex]?.topic));

            if (filteredTopics[randomIndex]) {
                usedTopics.push(filteredTopics[randomIndex].topic);
                currentTopicIndex = topics.findIndex(t => t.topic === filteredTopics[randomIndex].topic);
                document.getElementById('topic').innerText = filteredTopics[randomIndex].topic;
            } else {
                console.error('Selected topic is undefined. Check filtering logic.');
            }
        }

        function filterTopicsByLevel() {
            const difficultyGroups = {
                'A': ['A1', 'A2'],
                'B': ['B1', 'B2'],
                'C': ['C1', 'C2']
            };

            // Determine current difficulty group
            const currentGroup = Object.keys(difficultyGroups).find(group =>
                difficultyGroups[group].includes(playerLevel)
            );

            console.log('Player Level:', playerLevel);
            console.log('Difficulty Groups:', difficultyGroups);
            console.log('Current Group:', currentGroup);

            if (!currentGroup) {
                console.error('Current group not found for level:', playerLevel);
                return [];
            }

            // Count skips by difficulty group
            const skipsByGroup = Object.keys(difficultyGroups).reduce((acc, group) => {
                acc[group] = skippedTopics.filter(t => {
                    if (t.difficulty) {
                        return difficultyGroups[group].includes(t.difficulty);
                    } else {
                        console.warn('Skipped topic missing difficulty:', t);
                        return false;
                    }
                }).length;
                return acc;
            }, {});

            console.log('Skips by group:', skipsByGroup);

            // Adjust level based on skipped topics
            if (skipsByGroup[currentGroup] >= 3) {
                const easierGroup = getEasierGroup(currentGroup);
                if (easierGroup) {
                    console.log('Filtering by easier group:', easierGroup);
                    return topics.filter(t => difficultyGroups[easierGroup] && difficultyGroups[easierGroup].includes(t.difficulty));
                }
            }

            // Increase difficulty if too many topics answered from current group
            if (completedTopics[currentGroup] >= 2) {
                const harderGroup = getHarderGroup(currentGroup);
                if (harderGroup) {
                    console.log('Filtering by harder group:', harderGroup);
                    return topics.filter(t => difficultyGroups[harderGroup] && difficultyGroups[harderGroup].includes(t.difficulty));
                }
            }

            return topics.filter(t => difficultyGroups[currentGroup] && difficultyGroups[currentGroup].includes(t.difficulty));
        }

        function getEasierGroup(currentGroup) {
            const groups = { 'A': 'B', 'B': 'C', 'C': null };
            return groups[currentGroup];
        }

        function getHarderGroup(currentGroup) {
            const groups = { 'A': 'B', 'B': 'C', 'C': null };
            return Object.keys(groups).find(group => groups[group] === currentGroup);
        }

        function showDefinition() {
            isPaused = true;
            document.getElementById('definition-text').innerText = topics[currentTopicIndex]?.definition || 'No definition available.';
            document.getElementById('definition-modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('start-pause').innerText = 'Continue';
        }

        function closeDefinition() {
            isPaused = false;
            document.getElementById('definition-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('start-pause').innerText = 'Pause';
        }

        function updateTime() {
            const timeSelector = document.getElementById('time-selector');
            timeLeft = parseInt(timeSelector.value);
            document.getElementById('selected-time').innerText = timeLeft;
        }

        function skipTopic() {
            const skippedTopic = topics[currentTopicIndex];
            skippedTopics.push(skippedTopic);
            changeTopic();
            timeLeft = parseInt(document.getElementById('time-selector').value);
            document.getElementById('timer').innerText = timeLeft;
            completedTopics[playerLevel] = 0;
        }

        function answerTopic() {
            const currentTopic = topics[currentTopicIndex];
            completedTopics[currentTopic.difficultyGroup] = (completedTopics[currentTopic.difficultyGroup] || 0) + 1;
            changeTopic();
            timeLeft = parseInt(document.getElementById('time-selector').value);
            document.getElementById('timer').innerText = timeLeft;
        }
    </script>
</body>
</html>
