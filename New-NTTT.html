<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No Time to Think</title>
    <style>
        /* Your CSS here */
    </style>
</head>
<body>
    <div id="banner">
        <img src="NTTT.png" alt="Banner Image" style="width: 100%; height: 100%; object-fit: cover;">
    </div>
    <div id="topic">Press Start to Begin</div>
    <div id="definition-link" onclick="showDefinition()">What is this?</div>
    <div id="timer">20</div>
    
    <div>
        <input type="range" id="time-selector" min="10" max="30" step="10" value="20" onchange="updateTime()">
        <span id="selected-time">20</span> seconds (Recommended)
    </div>
    
    <div class="button-container">
        <button id="start-pause" onclick="startPauseGame()">Start</button>
        <button id="restart" onclick="restartGame()">Restart</button>
        <button id="skip" onclick="skipTopic()">Skip</button>
    </div>

    <div id="overlay"></div>
    <div id="definition-modal">
        <p id="definition-text"></p>
        <button onclick="closeDefinition()">Got it</button>
    </div>

    <script>
        let topics = [];
        let timer;
        let timeLeft = 20; // Default to 20 seconds
        let currentTopicIndex = 0;
        let isPaused = false;
        let usedTopics = [];
        let skippedTopics = [];
        let completedTopics = {
            'A': 0,
            'B': 0,
            'C': 0
        };
        let playerLevel = 'B'; // Default to B level

        // Fetch topics from JSON file
        fetch('NTTT-Topics.json')
            .then(response => response.json())
            .then(data => {
                topics = Object.values(data).flat();
                console.log('Topics loaded:', topics);
            })
            .catch(error => console.error('Error fetching topics:', error));

        function updateTimer() {
            if (isPaused) return;
            if (timeLeft <= 0) {
                changeTopic();
                timeLeft = parseInt(document.getElementById('time-selector').value);
            } else {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
            }
        }

        function startPauseGame() {
            const startPauseButton = document.getElementById('start-pause');
            const definitionLink = document.getElementById('definition-link');
            const timeSelector = document.getElementById('time-selector');

            if (!timer) {
                changeTopic();
                timer = setInterval(updateTimer, 1000);
                startPauseButton.innerText = 'Pause';
                document.getElementById('restart').style.display = 'block';
                document.getElementById('skip').style.display = 'block';
                definitionLink.style.display = 'block';
                timeSelector.disabled = true;
            } else if (isPaused) {
                isPaused = false;
                startPauseButton.innerText = 'Pause';
            } else {
                isPaused = true;
                startPauseButton.innerText = 'Continue';
            }
        }

        function restartGame() {
            clearInterval(timer);
            timer = null;
            timeLeft = parseInt(document.getElementById('time-selector').value);
            currentTopicIndex = 0;
            isPaused = false;
            usedTopics = [];
            skippedTopics = [];
            completedTopics = {
                'A': 0,
                'B': 0,
                'C': 0
            };
            document.getElementById('topic').innerText = 'Press Start to Begin';
            document.getElementById('timer').innerText = timeLeft;
            document.getElementById('restart').style.display = 'none';
            document.getElementById('skip').style.display = 'none';
            document.getElementById('start-pause').innerText = 'Start';
            document.getElementById('definition-link').style.display = 'none';
            document.getElementById('time-selector').disabled = false;
        }

        function changeTopic() {
            if (usedTopics.length === topics.length) {
                usedTopics = [];
            }

            let filteredTopics = filterTopicsByLevel();

            if (filteredTopics.length === 0) {
                filteredTopics = topics;
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * filteredTopics.length);
            } while (usedTopics.includes(filteredTopics[randomIndex].topic));
            usedTopics.push(filteredTopics[randomIndex].topic);
            currentTopicIndex = topics.findIndex(t => t.topic === filteredTopics[randomIndex].topic);
            document.getElementById('topic').innerText = filteredTopics[randomIndex].topic;
        }

        function filterTopicsByLevel() {
            const difficultyGroups = {
                'A': ['A1', 'A2'],
                'B': ['B1', 'B2'],
                'C': ['C1', 'C2']
            };

            // Determine current difficulty group
            const currentGroup = Object.keys(difficultyGroups).find(group =>
                difficultyGroups[group].includes(playerLevel)
            );

            console.log('Player Level:', playerLevel); // Debugging line
            console.log('Difficulty Groups:', difficultyGroups); // Debugging line
            console.log('Current Group:', currentGroup); // Debugging line

            if (!currentGroup) {
                console.error('Current group not found for level:', playerLevel);
                return [];
            }

            // Count skips by difficulty group
            const skipsByGroup = Object.keys(difficultyGroups).reduce((acc, group) => {
                acc[group] = skippedTopics.filter(t => {
                    if (t.difficulty) {
                        return difficultyGroups[group].includes(t.difficulty);
                    } else {
                        console.warn('Skipped topic missing difficulty:', t);
                        return false;
                    }
                }).length;
                return acc;
            }, {});

            console.log('Skips by group:', skipsByGroup); // Debugging line

            // Adjust level based on skipped topics
            if (skipsByGroup[currentGroup] >= 3) {
                const easierGroup = getEasierGroup(currentGroup);
                if (easierGroup) {
                    return topics.filter(t => difficultyGroups[easierGroup] && difficultyGroups[easierGroup].includes(t.difficulty));
                }
            }

            // Increase difficulty if too many topics answered from current group
            if (completedTopics[currentGroup] >= 2) {
                const harderGroup = getHarderGroup(currentGroup);
                if (harderGroup) {
                    return topics.filter(t => difficultyGroups[harderGroup] && difficultyGroups[harderGroup].includes(t.difficulty));
                }
            }

            return topics.filter(t => difficultyGroups[currentGroup] && difficultyGroups[currentGroup].includes(t.difficulty));
        }

        function getEasierGroup(currentGroup) {
            const groups = { 'A': 'B', 'B': 'C', 'C': null };
            return groups[currentGroup];
        }

        function getHarderGroup(currentGroup) {
            const groups = { 'A': 'B', 'B': 'C', 'C': null };
            return Object.keys(groups).find(group => groups[group] === currentGroup);
        }

        function showDefinition() {
            isPaused = true;
            document.getElementById('definition-text').innerText = topics[currentTopicIndex].definition;
            document.getElementById('definition-modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('start-pause').innerText = 'Continue';
        }

        function closeDefinition() {
            isPaused = false;
            document.getElementById('definition-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('start-pause').innerText = 'Pause';
        }

        function updateTime() {
            const timeSelector = document.getElementById('time-selector');
            timeLeft = parseInt(timeSelector.value);
            document.getElementById('selected-time').innerText = timeLeft;
        }

        function skipTopic() {
            const skippedTopic = topics[currentTopicIndex];
            skippedTopics.push(skippedTopic);
            changeTopic();
            timeLeft = parseInt(document.getElementById('time-selector').value);
            document.getElementById('timer').innerText = timeLeft;
            completedTopics[playerLevel] = 0;
        }

        function answerTopic() {
            const currentTopic = topics[currentTopicIndex];
            completedTopics[currentTopic.difficultyGroup] = (completedTopics[currentTopic.difficultyGroup] || 0) + 1;
            changeTopic();
            timeLeft = parseInt(document.getElementById('time-selector').value);
            document.getElementById('timer').innerText = timeLeft;
        }
    </script>
</body>
</html>
